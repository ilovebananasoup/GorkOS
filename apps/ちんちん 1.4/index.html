<!DOCTYPE html>
<html>
    <head>
        <title>Amplify Curriculum | Science</title>
        <link rel="stylesheet" href="css/style.css">
        <link rel="icon" type="image/x-icon" href="favicon.ico">
    <body>
        <div class="site-wrapper">
            <nav class="top-bar"><span></span> <!--<span class="add-game-button" id="addGameButton" onclick="openAddGameMenu()">&#43;</span>--></nav>
            
            <div class="add-game-menu open" id="addGameMenu">
                <label>Add Game</label>

                <span class="add-game-inputs"><label for="Titles">Title:</label><input id="title" type="text" name="Title" placeholder="EX: Super zawg dash Andrew Edition"></span>
                <span class="add-game-inputs"><label for="Link">Link:</label><input id="link" type="text" name="Link" placeholder="EX: https://andrewzawgtwin.com"></span>
                <span class="add-game-inputs"><label for="Image">Image:</label><input id="image" type="file" name="Image" placeholder="hammy"></span>

                <span class="add-game-inputs"><label for="Image" style="margin-top: 10px;"></label><button onclick="addGame()">Add</button></span>

                <label>IMPORTANT</label>
                <p>Saved games get deleted if you clear your cache/cookies, you can backup and load your games to/from a local file with the backup and load buttons respectively.</p>

                <button onclick="backupGames()">backup</button>
                <button onclick="openImportDialog()">load</button>
                <input
                    type="file"
                    id="importFile"
                    accept=".json"
                    style="display:none"
                    onchange="importGamesFromFile(this)"
                >

                <label>Settings</label>



            </div>

            <div class="game-area" id="gameArea">
                <!--<a class="game" onclick="openSite('https://yeehaw.com')" style="background-image: url('https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcR4_uRnaVJVGd2mB4zXyPHGisEVXlMx1bx1axxifBuRpxe1rYVe1PEY5cvcsO-o6k4dxqw4UwyqPExjZn5l6oBeXrpbldzbkWqnWrhwLlJC4w');"><div class="game-cookie"></div><div class="game-fortnite"><labeL>The Femboy Test</labeL></div></a>-->
            </div>

            <div class="vinnyballs"><input type="text" placeholder="custom site url goes here" id="ethansEnchantingEyes"><button onclick="openSite(document.getElementById('ethansEnchantingEyes').value)">gonk</button></div>
        </div>



        <script>

            const gameArea = document.getElementById("gameArea");
            function openSite(url) {
                const win = window.open();
                win.document.body.style.margin = "0";

                const iframe = win.document.createElement('iframe');
                iframe.style.width = "100%";
                iframe.style.height = "100%";
                iframe.style.border = "none";

                if (url.startsWith("http://") || url.startsWith("https://")) {
                    iframe.src = url;
                } else {
                    const absolutePath = `${window.location.pathname.replace(/\/[^\/]*$/, "/")}${url}`;
                    iframe.src = "file://" + absolutePath;
                }

                win.document.body.appendChild(iframe);
            }



            const DB_NAME = "gurb";
            const DB_VERSION = 1;
            const STORE_NAME = "games";

            function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                // HAHAHAHAHAHAHAH 676776767766
                request.onupgradeneeded = event => {
                const db = event.target.result;

                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: "id" });
                }
                };

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
            }

            openDB()
                .then(db => {
                    console.log("IndexedDB opened:", db.name);
                    db.close();
                })
                .catch(err => console.error("DB error:", err));



            async function saveGame(game) {
                const db = await openDB();
                const tx = db.transaction(STORE_NAME, "readwrite");
                const store = tx.objectStore(STORE_NAME);

            store.put(game);

            return new Promise((resolve, reject) => {
                tx.oncomplete = () => {
                    db.close();
                    resolve();
                };
                tx.onerror = () => reject(tx.error);
            });
            }

            async function loadGames() {
                const db = await openDB();
                const tx = db.transaction(STORE_NAME, "readonly");
                const store = tx.objectStore(STORE_NAME);
                return new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = () => {
                    db.close();
                    resolve(request.result);
                };
                request.onerror = () => reject(request.error);
                });
            }


            function addGame() {
                const titleInput = document.getElementById('title');
                const linkInput = document.getElementById('link');
                const imageInput = document.getElementById('image');
                const file = imageInput.files[0];

                if (!file) {
                    alert("Select an image");
                    return;
                }

                const reader = new FileReader();

                reader.onload = async (e) => {
                    const game = {
                        id: crypto.randomUUID(),
                        name: titleInput.value,
                        link: linkInput.value,
                        img: e.target.result
                    };

                    await saveGame(game);

                    titleInput.value = "";
                    linkInput.value = "";
                    imageInput.value = "";

                    await renderGames();
                };

                reader.readAsDataURL(file);
            }


            async function renderGames() {
                const games = await loadGames();
                const gameArea = document.getElementById("gameArea");

                gameArea.innerHTML = "";

                games.forEach(game => {
                    const card = document.createElement("a");
                    card.className = "game";
                    card.style.backgroundImage = `url('${game.img}')`;
                    card.onclick = () => openSite(game.link);

                    card.oncontextmenu = async (e) => {
                        e.preventDefault();

                        const confirmed = confirm(`Delete "${game.name}"?`);
                        if (!confirmed) return;

                        await deleteGame(game.id);
                        await renderGames();
                    };

                    const overlay = document.createElement("div");
                    overlay.className = "game-cookie";
                    card.appendChild(overlay);

                    const labelContainer = document.createElement("div");
                    labelContainer.className = "game-fortnite";

                    const label = document.createElement("label");
                    label.textContent = game.name;
                    labelContainer.appendChild(label);

                    card.appendChild(labelContainer);
                    gameArea.appendChild(card);
                });
            }


            window.onload = () => {
                renderGames();
            }


            async function backupGames() {
                const games = await loadGames();
                const json = JSON.stringify(games, null, 2);

                const blob = new Blob([json], { type: "application/json" });
                const url = URL.createObjectURL(blob);

                const a = document.createElement("a");
                a.href = url;
                a.download = "games-backup.json";
                a.click();

                URL.revokeObjectURL(url);
            }

            function openImportDialog() {
                document.getElementById("importFile").click();
            }

            async function importGamesFromFile(input) {
                const file = input.files[0];
                if (!file) return;

                const text = await file.text();
                const games = JSON.parse(text);

                for (const game of games) {
                    if (!game.id) {
                        game.id = Date.now() + "-" + Math.random();
                    }
                    await saveGame(game);
                }

                await renderGames();
                input.value = "";
            }

            async function deleteGame(id) {
                const db = await openDB();
                const tx = db.transaction(STORE_NAME, "readwrite");
                const store = tx.objectStore(STORE_NAME);

                store.delete(id);

                return new Promise((resolve, reject) => {
                    tx.oncomplete = () => {
                        db.close();
                        resolve();
                    };
                    tx.onerror = () => reject(tx.error);
                });
            }

        </script>
    </body>
</html>